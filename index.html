<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BrainyCam</title>
    <style>
        
        body { 
            font-family: Arial, sans-serif; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            margin: 0; 
            padding: 20px;
             background: blanchedalmond; 
             /* min-height: 100vh; */
            }
        .chat-container { 
            width: 100%;
            max-width: 800px; 
             background: white;
             display: flex;
             flex-direction: column;
             align-items: center; 
             justify-content: center;
              padding: 15px; 
              border-radius: 10px;
               box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); 
               height: 100vh;
            }
        .chat-box {
            margin: 0 auto;
            padding: 10px;
            font-family: sans-serif;
            display: inline-flexbox; 
            flex-direction: column;
            width: 700px;
            
            overflow-y: auto;
            /* border: 1px solid #ddd;
            border-radius: 8px; */
  }

  .message {
    display: flex;
    margin-bottom: 10px;
  }

  .message.ai {
    justify-content: flex-start;
  }

  .message.user {
    justify-content: flex-end;
  }

  .bubble {
    padding: 10px 15px;
    border-radius: 15px;
    max-width: 70%;
    white-space: pre-wrap;
    line-height: 1.5;
    word-wrap: break-word; 
    overflow-wrap: break-word; 
    overflow-x: auto; 
  }

  .message.ai .bubble {
    background-color: #f0f0f0;
    color: #333;
    border-top-left-radius: 0;
  }

  .message.user .bubble {
    background-color: #3b82f6;
    color: white;
    border-top-right-radius: 0;
  }
    

    .input-container { 
         
        display: inline-flexbox;
        width: 700px;
        flex-direction: column;
            /* overflow-y: auto; */
            padding: 16px;
        display: flex; 
        gap: 10px; 
        margin-top: 10px; 
        }
        .input-container input { flex: 1; padding: 8px; border-radius: 5px; border: 1px solid #ccc; }
        .input-container button { padding: 8px 12px; border: none; background: #007bff; color: white; border-radius: 5px; cursor: pointer; }
        .upload-area {
    width: 400px;
    height: 200px;
    border: 2px dashed #999;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #666;
    cursor: pointer;
    transition: 0.3s;
    display: inline-flex;  
  }

  .upload-area.dragover {
    background-color: #f0f8ff;
    border-color: #3b82f6;
    color: #3b82f6;
  }

  #videoPreview {
    margin-top: 20px;
    width: 400px;
    border-radius: 8px;
  }

  input[type="file"] {
    display: none;
  }

  .message.error .bubble {
  background-color: #fee2e2;  
  color: #b91c1c;             
  border: 1px solid #fca5a5;
  font-style: italic;
}

.message.error .bubble::before {
  content: "‚ö† ";
  font-weight: bold;
}
.fancy-title {
  font-size: 2.5rem;
  background: linear-gradient(90deg, #3b82f6, #9333ea, #3b82f6);
  background-size: 200% auto;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;

  animation: shine 3s linear infinite, zoomInOut 2s ease-in-out infinite;
}

@keyframes shine {
  0% { background-position: 0% center; }
  100% { background-position: 200% center; }
}

@keyframes zoomInOut {
  0%, 100% {
    transform: scale(1);
  }
  50% {
    transform: scale(1.1);
  }
}
    </style>
</head>
<body>

    <div class="chat-container">
        <h2 style="text-align: center; margin: 50px;font: size 100px;;" class="fancy-title">BrainyCam</h2>
        <div class="upload-area"  id="uploadArea">
            <p>üìÅ Drag video here or click to upload</p>
            <input type="file" id="fileInput" accept="video/*">
          </div>
        <video id="videoPreview" controls width="400"></video>
        <p id="fileName"></p>

        <div id="chatBox" class="chat-box">
            
          </div>
          
        <div class="input-container">
            <input type="text" id="questionInput" placeholder="Please ask a question:">
            <button id="sendBtn">Send</button>
        </div>
        <p id="status"></p>
    </div>

    <script>
        let videoId = null;

        // in test, replace backendurl with localhost:3000
       const backendUrl = 'http://i-1.gpushare.com:14285/upload'; 
         // const backendUrl = 'http://localhost:3000';

         const uploadArea = document.getElementById('uploadArea');
         const preview = document.getElementById('videoPreview');
        const chatBox = document.getElementById("chatBox");
        const status = document.getElementById("status");

       function appendMessage(content, sender = "ai") {
        const chatBox = document.getElementById("chatBox");

        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${sender}`;

        const bubble = document.createElement("div");
        bubble.className = "bubble";
        bubble.textContent = "";

        messageDiv.appendChild(bubble);
        chatBox.appendChild(messageDiv);

    
        chatBox.scrollTop = chatBox.scrollHeight;

        let i = 0;
        const typingSpeed = 30; // the interval

        function type() {
            if (i < content.length) {
                bubble.textContent += content.charAt(i);
                i++;
                chatBox.scrollTop = chatBox.scrollHeight; 
                setTimeout(type, typingSpeed);
        }
    }
    if (sender === "user") {
        bubble.textContent = content;
        } else {
   
        type();
}
}


        uploadArea.addEventListener('click', () => fileInput.click());


        uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        const file = e.dataTransfer.files[0];
        if (file && file.type.startsWith('video/')) {
            handleFile(file);
        }
        });

        

        document.getElementById("fileInput").addEventListener("change", async function(event) {
            const file = event.target.files[0];
            if (file && file.type.startsWith('video/')) {
                   handleFile(file);
                      }});

        async function handleFile(file){
            const videoURL = URL.createObjectURL(file);
            preview.src = videoURL;
            document.getElementById("fileName").textContent = "already choose: " + file.name;
            const formData = new FormData();
            formData.append("video", file);

                try {
                    console.log('the file is chosen')
                    const response = await fetch(`http://i-1.gpushare.com:14285/upload`, {
                        // const response = await fetch(`http://localhost:3000/upload`, {
                    method: "POST",
                    body: formData,
                    headers: {
                        "Accept": "application/json",
                        "Cache-Control": "no-cache" 
    }
                });
       

                const result = await response.json();
                console.log(result)
                status.innerText = result.message;
                // document.getElementById("videoUpload").value = "";
                } catch (error) {
                    console.error("Upload failure", error);
                    status.innerText='Upload failure'

                }
            }
        
            
        

        document.getElementById("sendBtn").addEventListener("click", async function() {
            const question = document.getElementById("questionInput").value.trim();
            if (!question) {
                alert("Please ask question");
                return;
            }

            appendMessage(`User:${question}`,'user');
            appendMessage("Processing...",'ai');
            document.getElementById("questionInput").value = "";

            try {
              
                const response = await fetch("http://i-1.gpushare.com:14285/ask", {
                    // const response = await fetch("http://localhost:3000/ask", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ question })
        });
        status.innerText = 'in process';

        const result = await response.json();
        status.innerText = ''
        console.log(result);

  
        chatBox.removeChild(chatBox.lastChild);

  
        appendMessage(result.raw, 'ai');
        // appendMessage(result.answer, 'ai');

            } catch (error) {
                console.error("Parse failure", error);
                const lastMessage = chatBox.lastChild;
                lastMessage.classList.add("message", "ai", "error"); 
                lastMessage.textContent = `Parse failure, please try again.`;
                
             
            }
        });
    </script>

</body>
</html>
